<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="styles/gis-battle.svg" type="image/svg+xml">
    <title>GIS Battle!</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel='stylesheet' href='styles/start-style.css'>
</head>
<body>
    <div id="bg-map"></div>

    <div id="content-overlay">
        <img id="logo" src="styles/gis-battle.svg" alt="GIS Battle Logo">
        <h1>GIS Battle!</h1>
        
        <button id="play-button">Start Game</button>
        <button id="join-button">Join Existing Game</button>
        <button id="browse-button">Browse GIS Toolkit</button>

        <img id="qr-code-gisbattle" src="styles/qr_code_gisbattle.png" alt="QR Code">
    </div>

    <div id="modal-overlay"></div>
    
    <div id="start-game-modal" class="modal">
        <h2>Create New Game</h2>
        <div>
            <label for="game-map">Select Map:</label>
            <select id="game-map" name="game-map">
                <option value="custom">Custom Map</option>
            </select>
        </div>
        
        <div>
            <label for="basemap-select">Basemap Style:</label>
            <select id="basemap-select" name="basemap-select">
            </select>
        </div>
        
        <div id="board-map"></div>

        <div>
            <label for="player-color">Choose your color:</label>
            <input type="color" id="player-color" name="player-color" value="#ff00ff">
        </div>
        <div>
            <label for="number-cards">Number of Cards:</label>
            <input type="number" id="number-cards" name="number-cards" value="3" min="2" max="7">
        </div>
        <div>
            <label for="initial-pieces">Starting Pieces:</label>
            <input type="number" id="initial-pieces" name="initial-pieces" value="10" min="5" max="25">
        </div>
        <div>
            <button id="confirm-start-game">Start Game</button>
            <button id="cancel-start-game">Cancel</button>
        </div>
    </div>

    <div id="join-game-modal" class="modal">
        <h2>Join Existing Game</h2>
        <div>
            <label for="game-id-input">Game ID:</label>
            <input type="text" id="game-id-input" name="game-id-input" placeholder="Enter Game ID">
        </div>
        <div>
            <label for="player-two-color">Choose your color:</label>
            <input type="color" id="player-two-color" name="player-two-color" value="#0000ff">
        </div>
        <div id="join-error" style="color: red; display: none;">Game not found. Please check the Game ID.</div>
        <div>
            <button id="confirm-join-game">Join Game</button>
            <button id="cancel-join-game">Cancel</button>
        </div>
    </div>

    <div id="browse-toolkit-modal" class="modal browse-toolkit-modal">
        <div class="browse-toolkit-header">
            <h2>GIS Toolkit - All Cards</h2>
            <button id="close-browse-toolkit" class="close-browse-btn">âœ•</button>
        </div>
        <div id="toolkit-cards-grid" class="toolkit-cards-grid">
        </div>
    </div>

    <script src='https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js'></script>
    <script src='https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js'></script>
    <script src='scripts/firebase-config.js'></script>
    <script src='scripts/basemaps.js'></script>
    <script src='scripts/game-setup.js'></script>
    <script src='scripts/card-mechanics.js'></script>
    <script>
        let db;
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        const gameStatesRef = db.ref('game-states');

        let bgMap;
        let boardMap;
        let bgMapSettings = {
            coordinates: [20, 0],
            zoom: 2,
            basemap: 'imagery'
        };
        let currentMapSettings = {
            coordinates: [20, 0],
            zoom: 2,
            basemap: 'imagery'
        };

        function initializeMap(containerId, mapSettings) {
            let map = L.map(containerId, {
                dragging: false,
                zoomControl: false,
                doubleClickZoom: false,
                scrollWheelZoom: false,
                touchZoom: false,
                keyboard: false
            }).setView(mapSettings.coordinates, mapSettings.zoom);

            const basemapLayer = getBasemapLayer(mapSettings.basemap);
            basemapLayer.addTo(map);

            map.on('moveend', function() {
                const center = map.getCenter();
                mapSettings.coordinates = [center.lat, center.lng];
                mapSettings.zoom = map.getZoom();
            });

            return map;
        }

        function updateMapFromPreset(preset) {
            currentMapSettings = {
                coordinates: [preset.lat, preset.lng],
                zoom: preset.zoom,
                basemap: preset.basemap
            };
            
            if (boardMap) {
                boardMap.setView([preset.lat, preset.lng], preset.zoom);
            }
        }

        function enableMapControls(map) {
            if (map) {
                map.dragging.enable();
                map.scrollWheelZoom.enable();
                map.doubleClickZoom.enable();
                map.touchZoom.enable();
                map.addControl(L.control.zoom());
            }
        }

        function disableMapControls(map) {
            if (map) {
                map.dragging.disable();
                map.scrollWheelZoom.disable();
                map.doubleClickZoom.disable();
                map.touchZoom.disable();
                if (map.zoomControl) {
                    map.removeControl(map.zoomControl);
                }
            }
        }

        bgMap = initializeMap('bg-map', bgMapSettings);
        
        function populateBasemapSelector() {
            const selector = document.getElementById('basemap-select');
            const basemapKeys = getBasemapKeys();
            
            basemapKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = getBasemapName(key);
                if (key === 'imagery') {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        document.getElementById('player-color').value = getRandomBrightColor();
        document.getElementById('player-two-color').value = getRandomBrightColor();
        
        populateBasemapSelector();

        document.getElementById('play-button').onclick = function() {
            document.getElementById('start-game-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            
            setTimeout(() => {
                if (boardMap) {
                    boardMap.remove();
                }
                boardMap = initializeMap('board-map', currentMapSettings);
                updateMapFromPreset(mapPresets['world']);
            }, 100);
        };
        
        document.getElementById('game-map').onchange = function() {
            const selectedMap = this.value;
            
            if (selectedMap === 'custom') {
                enableMapControls(boardMap);
            } else {
                disableMapControls(boardMap);
                updateMapFromPreset(mapPresets[selectedMap]);
            }
        };
        
        document.getElementById('basemap-select').onchange = function() {
            const selectedBasemap = this.value;
            currentMapSettings.basemap = selectedBasemap;
            
            if (boardMap) {
                boardMap.remove();
            }
            boardMap = initializeMap('board-map', currentMapSettings);
            
            const selectedMapPreset = document.getElementById('game-map').value;
            if (selectedMapPreset === 'custom') {
                enableMapControls(boardMap);
            }
        };
        
        document.getElementById('cancel-start-game').onclick = function() {
            closeModals();
        };
        
        document.getElementById('join-button').onclick = function() {
            document.getElementById('join-game-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('join-error').style.display = 'none';
        };

        document.getElementById('cancel-join-game').onclick = function() {
            closeModals();
        };
        
        document.getElementById('browse-button').onclick = function() {
            openBrowseToolkitModal();
        };
        
        document.getElementById('confirm-start-game').onclick = function() {
            const playerOneColor = document.getElementById('player-color').value;
            const numberOfCards = parseInt(document.getElementById('number-cards').value);
            const initialPieces = parseInt(document.getElementById('initial-pieces').value);
            
            const rgbaColor = hexToRgba(playerOneColor);
            
            createGame(rgbaColor, numberOfCards, initialPieces, currentMapSettings.coordinates, currentMapSettings.zoom, currentMapSettings.basemap);
        };
        
        document.getElementById('confirm-join-game').onclick = function() {
            const gameId = document.getElementById('game-id-input').value.trim();
            const playerTwoColor = document.getElementById('player-two-color').value;
            
            if (!gameId) {
                alert("Please enter a Game ID");
                return;
            }
            
            const rgbaColor = hexToRgba(playerTwoColor);
            
            joinGame(gameId, rgbaColor);
        };

        const presetSelect = document.getElementById("game-map");
        populatePresetDropdown(presetSelect);
        
        function closeModals() {
            document.getElementById('start-game-modal').style.display = 'none';
            document.getElementById('join-game-modal').style.display = 'none';
            document.getElementById('browse-toolkit-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('join-error').style.display = 'none';
            
            if (boardMap) {
                boardMap.remove();
                boardMap = null;
            }
        }

        function openBrowseToolkitModal() {
            document.getElementById('browse-toolkit-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
            populateToolkitGrid();
        }

        function populateToolkitGrid() {
            const grid = document.getElementById('toolkit-cards-grid');
            grid.innerHTML = '';

            for (const [key, card] of Object.entries(cardTypes)) {
                const cardElement = createToolkitCardElement(card);
                grid.appendChild(cardElement);
            }
        }

        function createToolkitCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'toolkit-card';

            const cardId = document.createElement('div');
            cardId.className = 'toolkit-card-id';

            const title = document.createElement('div');
            title.className = 'toolkit-card-title';
            title.textContent = card.name;
            cardDiv.appendChild(title);

            const description = document.createElement('div');
            description.className = 'toolkit-card-description';
            description.textContent = card.description;
            cardDiv.appendChild(description);

            return cardDiv;
        }

        document.getElementById('close-browse-toolkit').onclick = function() {
            closeModals();
        };
    </script>
</body>
</html>